
## Протоколы сетевого взаимодействия для передачи динамических структур

### Подключаемые файлы

*  nc3.hpp - классы для реализации сетевых протоколов с автоматическим поиском узлов (nc3::node_server, nc3::node_client, nc3::node)
*  nc2.hpp - классы для совместимости со старым протоколом узлов nc2 (nc2::node_server, nc2::node_client)
*  protocols/*.h - заголовочные файлы протоколов

Остальные заголовочные файлы подключать не нужно.

### Реализация протокола

Протокол взаимодействия состоит из набора структур. Все заголовочные файлы протоколов находятся в каталоге protocols. Каждая структура протокола должна иметь следующий вид:
```
struct client_to_server_structure
{
    enum
    {
        protocol = код_протокола,
        message = код_сообщения
    };
    // поля структуры
};
```
* Код_протокола - номер протокола по порядку, зарезервированный в protocols/readme.md. 
* Код_сообщения - номер сообщения по порядку, для нумерации можно использовать отдельный enum.

В качестве полей структуры могут быть следующие типы:
* простые типы данных (int32_t, float, int64_t, ...)
* строки std::string (рекомендуемая кодировка utf8)
* std::vector
* std::map, std::unordered_map, std::multimap, std::unordered_multimap
* std::optional
* std::variant
* другие структуры
* массивы всех перечисленных типов


Перечисленные контейнеры стандартной библиотеки могут содержать любой допустимый тип.

Не рекомендуется использовать:
 * std::wstring (размер wchar_t разный в разных ОС, для существующих протоколов поменять на std::u16string)
 * long (разный размер в разных ОС)
 * long double (разный размер в разных ОС)
 * size_t (разный размер в 32 и 64 битных программах)
 * std::variant с набором типов, который может поменяться при развитии протокола

### Расширение протоколов

При необходимости протокол можно расширять, добавляя поля в конец структур. Удаление полей и добавление их не в конец структуры недопустимо. Код протокола и код сообщения изменять нельзя. Если отправитель структуры передал структуру старого формата (без добавленного поля), у получателя отсутствующие поля будут заполнены значением по-умолчанию. При заполнении структур для отправки рекомендуется их инициализировать, чтобы не передавать некорректные значения добавленных полей, пример:
```
client_to_server_structure message{};
// заполнение полей message
client_->send(id, message);
```

### Использование

* Подключить nc3.hpp.
* Создать экземпляр класса node_server или node_client. Все клиенты будут подключены ко всем серверам.
* Вызвать метод класса register_handler<msg1, ... , msgN>(handler), где msg* - типы принимаемых структур, handler - указатель на класс-обработчик.
* Вызвать метод start().
* Отправить сообщение методом send().
* По окончанию работы вызвать метод stop().

После возврата из метода stop() гарантируется, что обработчики больше не будут вызваны.

Обработчик должен содержать следующие методы:
1. void connected(nc3::point_id_t id, nc3::address_t address, nc3::port_t port)
    * id - идентификатор подключенного удалённого узла (для сопоставления входящих сообщений и идентификации получателя отправляемых сообщений)
    * address - сетевой адрес удалённого узла (ipv4)
    * port - порт удалённого узла
2. void disconnected(nc3::point_id_t id)
   * id - идентификатор отключенного узла
3.  void message(nc3::point_id_t id, const msg1& msg)
     * id - идентификатор узла отправителя
     * msg - сообщение

Количество методов message и типы сообщений соотвествуют количеству и типам структур, переданных в аргуменах шаблона в register_handler

Если требуется скрыть методы класса connected\disconnected\message от пользователя (поместить в область private класса), то для работы бибилиотеки нужно разрешить доступ классу nc3::node:
```
friend class nc3::node;
```

### Идентификаторы узлов

Идентификаторы узлов имеют тип nc3::point_id_t. Гарантируется, что идентификаторы всех подключенных в данный момент узлов для одного экземпляра класса nc3::node уникальны. Переносимость идентификаторов узлов между разными экземплярами класса nc3::node не гарантируется. Идентификатор актуален в момент времени между событиями connected и disconnected. При отправке сообщения на несуществующий идентификатор узла, сообщение будет отброшено.

### Переменные окружения

* NC3_IGNORE_INTERFACE - список локальных ip адресов для запрета сетевого взаимодействия. Резделитель списка ; или :.
* NC3_ENABLE_LOG=1 - включение журнала обмена (файлы помещаются в текущую  директорию).

### Дополнительные функции
* std::string nc3::address_to_string(address_t address, port_t port) - преобразование адреса узла в строку

### Настройка рабочего места linux
Для корректной работы ПО с правами пользователя нужно разрешить bind для портов ниже 1024. Для этого можно создать файл /etc/sysctl.d/ip_unprivileged_port.conf со следующим содержимым:
```
net.ipv4.ip_unprivileged_port_start=0
```
После этого выполнить перезагрузку.

Для запрета работы nc3 по отдельному интерфейсу в linux можно использовать iptables, пример:

```
iptables -I INPUT -i eth0 -p udp --dport 781 -j DROP
iptables -I OUTPUT -o eth0 -p udp --dport 781 -j DROP
```


### Типы узлов
В конструкторе класса nc3::node можно указать тип узла. Допустимые типы:
* nc3::node_type::local_client - клиент, взаимодействие в локальной сети
* nc3::node_type::local_server - сервер, взаимодействие в локальной сети
* nc3::node_type::global_client - клиент, взаимодействие в нескольких сетях
* nc3::node_type::global_server - сервер, взаимодействие в нескольких сетях
* nc3::node_type::host_client - клиент, взаимодействие внутри хоста
* nc3::node_type::host_server - сервер, взаимодействие внутри хоста

Правила взаимодействия узлов различных типов представлены в таблице:

| Пара узлов       | Один хост | Локальная сеть | Глобальная сеть (netun) |
|------------------|-----------|----------------|-------------------------|
| host - host      | +         | -              | -                       | 
| host - local     | +         | -              | -                       | 
| host - global    | +         | -              | -                       | 
| local - local    | +         | +              | -                       | 
| local - global   | +         | +              | -                       | 
| global - global  | +         | +              | +                       | 
